Tags:[RPC]

#### 什么是RPC

RPC(Remote Procedure Call),  远程过程调用。

是分布式系统常见的一种通信方法，已经有 40 多年历史。当两个物理分离的子系统需要建立逻辑上的关联时，RPC 是牵线搭桥的常见技术手段之一。

其他常见的多系统数据交互方案还有:

* 分布式消息队列
* HTTP 请求调用
* 数据库
* 分布式缓存

其中， RPC和HTTP是没有经过中间件的， 是端到端直接的数据交互。

但是在一些中间件中都有它的身影, 本质上是RPC技术的一种应用组合。如数据库：`System - (rpc) - Database - (rpc) -System`

HTTP 可以看作是一种特殊的 RPC, 只不过传统意义上的RPC是指**长连接数据交互**

而HTTP一般是指即用即走的短连接。

总结：

* TCP, UDP 等通信协议
* 一般离不开socket——消息的载体
* 在socket 封装的新协议，如HTTP1.1 和WebSocket。 协议规定了消息格式，定义了消息内容和边界。
* 长连接



#### Nginx 和 RPC

Nginx 和 后端服务之间的交互也可以理解为RPC数据交互。

但你会说他们直接调用的是HTTP协议，走的是短连接，算不上是RPC调用。

不过 Nginx 和后端服务之间还可以走其它的协议，比如 uwsgi 协议、fastcgi 协议等，这两个协议都是采用了比 HTTP 协议更加节省流量的**二进制协议**



#### Hadoop 与RPC

大数据领域广泛应用了非常多的分布式技术，分布式意味着节点的物理隔离，隔离意味着需要通信，通信意味着 RPC 的存在。大数据需要通信的量比业务系统更加庞大，所以在数据通信优化上做的更深。



#### 再谈HTTP调用，它是一种特殊的RPC

HTTP1.0 协议时，HTTP 调用还只能是短链接调用，一个请求来回之后连接就会关闭。

HTTP1.1 在 HTTP1.0 协议的基础上进行了改进，引入了 KeepAlive 特性可以保持 HTTP 连接长时间不断开，以便在同一个连接之上进行多次连续的请求，进一步拉近了 HTTP 和 RPC 之间的距离...

当 HTTP 协议进化到 2.0 之后，Google 开源了一个建立在 HTTP2.0 协议之上的通信框架直接取名为 gRPC，也就是 Google RPC，这时 HTTP 和 RPC 之间已经没有非常明显的界限了。所以在后文我们不再明确强调 RPC 和 HTTP 请求调用之间的细微区别了，直接统一称之为 RPC。...



#### 交互流程

**RPC 的客户端通过文件描述符的读写 API (read & write) 来访问操作系统内核中的网络模块为当前套接字分配的发送 (send buffer) 和接收 (recv buffer) 缓存。**

思考： 如果客户端疯狂发请求，但服务器不读处理，会发生什么？

recv buffer 会满导致阻塞。



### 协议设计

```
长度前缀 <-    消息边界  -> 特殊符号分割
                 |
二进制   <-    消息表示  -> 文本
                 |
有模式   <-    消息结构  -> 无模式
                 |
              压缩算法
```

 ####  消息边界

RPC 需要在一条 TCP 链接上进行多次消息传递。在连续的两条消息之间必须有明确的分割规则，以便接收端可以将消息分割开来

基本两种方法：

* 特殊符号分割：每条消息末追加特殊分割符，比较常见的是`\r\n`, 如HTTP和Redis 协议。如果文中怕有和特舒符号重复的，可以使用base64编码。

* 长度前缀：消息开头有固定长度的整数值，记录该信息的长度，接受端读取相应长度就可以将一个完整的信息分离出来。

  HTTP 协议的 Content-Length 头信息用来标记消息体的长度，这个也可以看成是长度前缀法的一种应用。

HTTP 协议是一种基于特殊分割符和长度前缀法的混合型协议。比如 HTTP 的消息头采用的是纯文本外加\r\n 分割符，而消息体则是通过消息头中的 Content-Type 的值来决定长度。HTTP 协议虽然被称之为文本传输协议，但是也可以在消息体中传输二进制数据数据的，例如音视频图像，所以 HTTP 协议被称之为「超文本」传输协议。...



#### 消息的结构

每条消息都有它包含的语义结构信息

如json. 结构鲜明，可读性强。

缺点，太多的冗余信息， 如括号，引号，逗号，最大的冗余在多json信息结构完全一样，还要传key.

信息的结构在同一条消息通道上是可以复用的，比如在建立链接的开始 RPC 客户端和服务器之间先交流协商一下消息的结构，后续发送消息时只需要发送一系列消息的 value 值，接收端会自动将 value 值和相应位置的 key 关联起来，形成一个完成的结构消息。在 Hadoop 系统中广泛使用的 avro 消息协议就是通过这种方式实现的，在 RPC 链接建立之处就开始交流消息的结构，后续消息的传递就可以节省很多流量。



#### 消息压缩

如果消息内容太大，可以对消息进行压缩，虽然减小了网络压力，但会加重CPU的压力，所以一定要权衡。

如果确定要压缩，一定要选择C语言实现的压缩算法，比如Google的snappy.

极致的流量优化，长度字节可变编码varint（对负数优化： zigzag）

* varint

  消息传递时大部分数值都是很小的非负整数，全用四个字节表示比较浪费，varint 就是长度跟随数的大小而变化的， 当数非常小时， 只用一个字节，7bit + 1bit标识位。

  数大时相应的增加字节。

* zigzag

  上诉编码 不能够很好的表示负数，而zigzag编码是将负数映射到自然数。

###  