---
title: "Golang依赖注入框架wire"
date: 2020-03-17 15:10:43 +0800
lastmod: 2020-06-15 09:12:32 +0800
draft: false
tags: [""]
categories: [""]
author: "Claymore"

---



## wrie

https://github.com/google/wire

安装：go get github.com/google/wire/cmd/wire



### start

项目中简单创建两个文件：

main.go:

```go
package main

import "fmt"

type Message struct {
   msg string
}
type Greeter struct {
   Message Message
}

type Event struct {
   Greeter Greeter
}

func NewMessage(msg string) Message {
   return Message{
      msg:msg,
   }
}

func NewGreeter(m Message) Greeter {
   return Greeter{Message: m}
}

func NewEvent(g Greeter) Event {
   return Event{Greeter: g}
}
func (e Event) Start() {
   msg := e.Greeter.Greet()
   fmt.Println(msg)
}
func (g Greeter) Greet() Message {
   return g.Message
}

func main() {
   message := NewMessage("hello world")
   greeter := NewGreeter(message)
   event := NewEvent(greeter)

   event.Start()
}
```

上述main.go 是一个简单创建event结构的过程，使用wire框架可以简化 main() 函数中初始化的过程：

wire.go:

``` go
// +build wireinject  //  用于告诉编译器无需编译该文件
// The build tag makes sure the stub is not built in the final build.

package main

import "github.com/google/wire"

// InitializeEvent 声明injector的函数签名
func InitializeEvent(msg string) Event {
	wire.Build(NewEvent, NewGreeter, NewMessage)
	return Event{}  //返回值没有实际意义，只需符合函数签名即可
}
```

在当下目录执行：wrie

``` sh
E:\gitCompany\src\goSrcTest\wrieTest>wire
wire: goSrcTest/wrieTest: wrote E:\gitCompany\src\goSrcTest\wrieTest\wire_gen.go
```

生成了一个新文件wrie_gen.go:

``` go
// Code generated by Wire. DO NOT EDIT.

//go:generate wire     
//+build !wireinject

package main

// Injectors from wrie.go:

func InitializeEvent(msg string) Event {
	message := NewMessage(msg)
	greeter := NewGreeter(message)
	event := NewEvent(greeter)
	return event
}
```

可见，wire 自动确定依赖，自动完成结构体的初始化

此时 main.go 中的 main函数可以改为：

``` go
// 使用wire后
func main() {
	event := InitializeEvent("hello_world")
	event.Start()
}
```

这样看代码是不是少了一些。



### provider 和 injector

`provider`和`injector`是`wire`的两个核心概念。可以简单的理解为，提供者和注射器。

通过提供`provider`函数，让`wire`知道如何产生这些依赖对象。`wire`根据我们定义的`injector`函数签名，生成完整的`injector`函数，`injector`函数是最终我们需要的函数，它将按依赖顺序调用`provider`。

在上方例子中， `NewMessage,NewGreeter,NewEvent`都是`provider`，`wire_gen.go`中的`InitializeEvent`函数是`injector`，可以看到`injector`通过**按依赖顺序调用**`provider`来生成我们需要的对象`Event`。

