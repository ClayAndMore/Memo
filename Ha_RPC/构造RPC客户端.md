### 设计要点

#### 多线程

模型：

![](http://ovolonhm1.bkt.clouddn.com/client_mode.png)

客户端往往不是单线程的，客户端和数据库之间会维护一个线程池pool，

当线程中的代码需要访问数据库时，先从连接池中获取一个连接，与数据库交互完成后再将这个连接归还给线程池。所以对于业务线程来说，拿到的连接不会同时被其它线程共享，这样就有效避免了并发问题。

另外，服务器的性能往往随着并发连接数量的增加而下降，所以必须严格控制有效连接的数量。



#### 安全锁

连接池为多线程而设计，每个线程都会访问线程池对象，所以线程池需要使用锁来控制数据结构的安全。安全锁可以带来安全，但是也会导致性能受损。锁的临界区代码要尽量避免耗时的计算和 IO 操作。锁的力度还要尽可能的细，但是细力度的锁代码编写起来也是有一定的难度，容易出错。

考虑到连接都是用来进行相对缓慢的 IO 操作，锁这样的内存型操作耗时相比 IO 操作可以忽略不计，所以采用粗粒度的锁可能会是一个非常明知的选择，在性能许可的前提下，代码写得简单不容易出错。
