###  Redis 文本协议结构

Antirez（Redist 作者） 认为数据库系统的瓶颈一般不在于网络流量，而是数据库自身内部逻辑处理上。

所以即使 Redis 使用了浪费流量的文本协议，依然可以取得极高的访问性能。Redis 将所有数据都放在内存，用一个单线程对外提供服务，单个节点在跑满一个 CPU 核心的情况下可以达到了 10w/s 的超高 QPS。.

#### RESP

Redis 有一套专用的通讯协议RESP

Redis Serialization Protocol, Redis 序列协议。

Redis 协议将传输的结构数据分为 5 种最小单元类型，单元结束时统一加上回车换行符号\r\n。

```
单行字符串 以+符号开头；

多行字符串 以$符号开头，后跟字符串长度；

整数值 以:符号开头，后跟整数的字符串形式；

错误消息 以-符号开头；

数组 以*号开头，后跟数组的长度
```



####  发送指令

客户端->服务端

客户端向服务器发送的指令只有一种格式，多行字符串数组。比如一个简单的 set 指令set author codehole会被序列化成下面的字符串。

`*3\r\n$3\r\nset\r\n$6\r\nauthor\r\n$8\r\ncodehole\r\n`
在控制台输出这个字符串如下，可以看出这是很好阅读的一种格式。

*3
$3
set
$6
author
$8
codehole...

服务端->客户端

服务器向客户端回复的响应要支持多种数据结构，所以消息响应在结构上要复杂不少。不过再复杂的响应消息也是以上 5 中基本类型的组合。

* 单行字符串响应

  127.0.0.1:6379> set author codehole
  OK
  这里的 OK 就是单行响应，没有使用引号括起来。

  +OK

* 错误响应

  ```
  127.0.0.1:6379> incr author

  (error) ERR value is not an integer or out of range

  试图对一个字符串进行自增，服务器抛出一个通用的错误。

  -ERR value is not an integer or out of range
  ```

* 整数响应

  ```
  127.0.0.1:6379> incr books

  (integer) 1

  这里的1就是整数响应。

  :1
  ```

* 多行字符串响应

    ```
    127.0.0.1:6379> get author

    "codehole"

    这里使用双引号括起来的字符串就是多行字符串响应。

    $8

    codehole
    ```

* 数组响应


    ```
    127.0.0.1:6379> hset info name laoqian

    (integer) 1

    127.0.0.1:6379> hset info age 30

    (integer) 1

    127.0.0.1:6379> hset info sex male

    (integer) 1

    127.0.0.1:6379> hgetall info

    1) "name"

    2) "laoqian"

    3) "age"

    4) "30"

    5) "sex"

    6) "male"

    这里的 hgetall 命令返回的就是一个数值，第 0|2|4 位置的字符串是 hash 表的 key，第 1|3|5 位置的字符串是 value，客户端负责将数组组装成字典再返回。

    *6
    $4
    name
    $6
    laoqian
    $3
    age
    $2
    30
    $3
    sex
    $4
    male
    ```

    ​

* 嵌套

    ```
    127.0.0.1:6379> scan 0

    1) "0"

    2) 1) "info"

       2) "books"

       3) "author"

    scan 命令用来扫描服务器包含的所有 key 列表，它是以游标的形式获取，一次只获取一部分。

    scan 命令返回的是一个嵌套数组。数组的第一个值表示游标的值，如果这个值为零，说明已经遍历完毕。如果不为零，使用这个值作为 scan 命令的参数进行下一次遍历。数组的第二个值又是一个数组，这个数组就是 key 列表。

    *2
    $1
    0
    *3
    $4
    info
    $...
    ```



### Protebuf 二进制协议结构

Protobuf 协议是 Google 开源的二进制 RPC 通讯协议，它可能是互联网开源项目中使用最为广泛的 RPC 协议。

Protobuf 提供了一种描述通讯协议的接口描述语言 IDL，通过编写接口协议，Protobuf 可以自动生成多种语言的 RPC 通讯代码，目前官方已经支持了近 10 种语言。

#### 协议格式

`| key1 | value1 | key2 | value2 | key3 | value31 |  key3 | value32 |`

 Protobuf 传输的是一系列的键值对，如果连续的键重复了，那说明传输的值是一个列表 (repeated)。图上的 key3 就是一个列表类型 (repeated)。