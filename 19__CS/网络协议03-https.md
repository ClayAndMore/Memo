Tags:[网络协议]

## https

HTTP本身没有任何保密性，所以HTTP传输的数据相当于都是在网上在以明文的方式裸奔。为了解决这个问题，出现了各种加密技术：

### 加密算法

* 对称加密

  唯一密钥`key1`可用来加密也可用来解密。这样的加密需要双方都拥有密钥`key1`，如果第一次传输密钥被第三方截获就玩完。

* 非对称加密

  公钥`key3`和私钥`key2`都可用于对应的加密和解密，传输字段即可用公钥加密私钥解密，也可用私钥加密公钥解密。

  服务端会生成一对密钥，一个私钥保存在服务端，仅自己知道，另一个是公钥，公钥可以自由发布供任何人使用。

  客户端的明文通过公钥加密后的密文需要用私钥解密。非对称密钥在加密和解密的过程的使用的密钥是不同的密钥，加密和解密是不对称的，所以称之为非对称加密。

  与对称密钥加密相比，非对称加密无需在客户端和服务端之间共享密钥，只要私钥不发给任何用户，即使公钥在网上被截获，也无法被解密，仅有被窃取的公钥是没有任何用处的。

* 混合加密

  服务端先用非对称加密的私钥`key2`加密对称加密的密钥`key1`并传给客户端，客户端用非对称加密的公钥`key3`解密出对称加密的密钥`key1`，双方都有了密钥`key1`，开始利用`key1`加密通信。

  **缺点**：中间人可以自己生成非对称加密公钥替换掉服务端公钥发送给客户端，而此时客户端并无法验证公钥的可信性。



HTTPS一般使用的加密与HASH算法如下：

- 非对称加密算法：RSA，DSA/DSS
- 对称加密算法：AES，RC4，3DES
- HASH算法：MD5，SHA1，SHA256



接下来是重点：SSL

### SSL

TLS/SSL中使用了非对称加密，对称加密以及HASH算法。

HTTPS在传输数据之前需要客户端（浏览器）与服务端之间进行一次握手，在握手过程中将确立双方加密传输数据的密码信息。

1. 服务器首先需要从证书认证机构申请证书（证书中含有证书签名和服务端公钥`key3`）。

2. 在客户端发起HTTP请求时，将自己支持的一套加密规则发送给服务器。

3. 服务器从中选出一组**加密算法**与**HASH算法**，并将自己的身份信息以证书的形式发回给浏览器（这里证书的形式目测是证书公钥再次加密的）。证书里面包含了网站地址，加密公钥，以及证书的颁发机构等信息。  

4. 客户端接下来的工作：

   a) 验证证书的合法性（颁发证书的机构是否合法，证书中包含的网站地址是否与正在访问的地址一致等），如果证书受信任，则浏览器栏里面会显示一个小锁头，否则会给出证书不受信的提示。  

   b) 证书受信任，或者是用户接受了不受信的证书，浏览器会生成一串随机数的密码`key1`，并用证书中提供的公钥`key3`加密。  

   c) 使用约定好的HASH算法计算握手消息，并使用生成的随机数密码`key1`对该握手消息进行加密，最后将之前生成的所有信息发送给网站。 

5. 服务器接收浏览器发来的数据之后要做以下的操作： 

    a) 使用自己的私钥`key2`将信息解密取出密码`key1`，使用密码`key1`解密浏览器发来的握手消息，并验证HASH是否与浏览器发来的一致。

   b) 使用密码加密`key1`一段握手消息 和 握手消息的 HASH 发送给浏览器。 

6. 浏览器解密并计算握手消息的HASH，如果与服务端发来的HASH一致，此时握手过程结束，之后所有的通信数据将由之前浏览器生成的随机密码`key1`并利用对称加密算法进行加密。 

这里浏览器与网站互相发送加密的握手消息并验证，目的是为了保证双方都获得了一致的密码，并且可以正常的加密解密数据，为后续真正数据的传输做一次测试。

至于安全性，假设我们有一个中间人B, 它在客户端和服务端第一次通信的时候拿到了证书, 但是它没有证书的私钥，解不开里面的内容，由于私钥是机构的，可以避免第三方伪造证书。

并且就算得到了服务端公钥，也无法解密出公钥`key3`加密过的对称加密密钥`key1`。



### SSL劫持

对HTTPS最常见的攻击手段就是SSL证书欺骗或者叫SSL劫持，是一种典型的中间人攻击。不过SSL劫持并非只是用于攻击目的，在一些特殊情况下利用SSL劫持我们可以更顺畅的访问网络，我会在后文提到。

以攻击为目的的SSL劫持如果不注意浏览器安全提示的话，很容易就中招。当网络中有中间人发起SSL劫持攻击时，攻击者需要伪造一个SSL证书发给浏览器，这个时候由于伪造的SSL证书不受信任，浏览器会给出提示。

这里有一个误区，当SSL证书不受信任的时候，并不一定就是有SSL劫持发生，有种例外情况是：一些个人网站买不起合法的SSL证书，因此会自己制作一个SSL证书来加密传输的数据。如果你经常访问某个个人网站，而且你知道这个网站是干什么的，那么这种情况可以不用担心。但是如果你访问的是网银，在线支付，或者是hotmail.com，gmail.com等，这类公司性质的网站一定会申请合法的SSL证书（12306.cn除外），一旦SSL证书不受信任，应该果断的终止访问.



### 特点

HTTPS基于HTTP协议，通过SSL或TLS（可以看作SSL3.0）提供加密处理数据、验证对方身份以及数据完整性保护。特点如下：

- 内容加密：采用混合加密技术，中间者无法直接查看明文内容
- 验证身份：通过证书认证客户端访问的是自己的服务器
- 保护数据完整性：防止传输的内容被中间人冒充或者篡改



### HTTPS和HTTP的区别

1. HTTPS协议需要到CA（证书颁发机构）申请证书，一般免费证书很少，需要交费。
2. HTTP协议运行在TCP之上，所有传输的内容都是明文，HTTPS运行在SSL/TLS之上，SSL/TLS运行在TCP之上，所有传输的内容都经过加密的。
3. HTTP和HTTPS使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。
4. http的连接很简单，是无状态的；HTTPS协议是由HTTP+SSL协议构建的可进行加密传输、身份认证的网络协议，可以有效的防止运营商劫持，解决了防劫持的一个大问题，比http协议安全。











