Tags:[网络协议] date: 2017-04-04



### OSI 网络模型

开放系统互联(Open System Interconnection),:

```
应用层
表示层
会话层
传输层      传输可靠性，TCP协议和UDP
网络层      IP协议，IP地址，子网掩码网络层使用，路由和交换机在此层工作（也称之为三层交换机）
数据链路层   错误检测和恢复，物理硬件地址的定义， eg， MAC地址， PPP协议。
物理层      传输介质，传输比特
```



### IP编址和子网划分

ipv4地址的分类网络：

| 类型         | 地址范围                                                     | 子网掩码      |      |
| ------------ | ------------------------------------------------------------ | ------------- | ---- |
| A            | 0.0.0.0 ~ 127.255.255.255                                    | 255.0.0.0     |      |
| B            | 128.0.0.0 ~ 192.255.255.255                                  | 255.255.0.0   |      |
| C            | 192.0.0.0 ~ 223.255.255.255                                  | 255.255.255.0 |      |
| D            | 224.0.0.0 ~ 239.255.255.255                                  | 常用于组播。  |      |
| E和未分配    |                                                              |               |      |
| 网络地址     |                                                              |               |      |
| 回环网络地址 |                                                              |               |      |
| 广播地址     | 直接广播（255.255.255.255）受限广播：主机部分设置为1，eg:192.168.10.255 |               |      |

子网掩码：每种网络类型的网络地址都有一个默认的子网掩码， **用于指定IP地址里用于网络部分和用于主机部分的划分。**

eg: C类网络的子网掩码是255.255.255.0， 因此在C类网络中一共有254个主机（去掉0和255）

**使用默认的子网掩码被分成的不同网络便是分类网络。**

但是我们通常还会使用更小的网络划分，也就是无分类的子网划分也是可行的。

可以通过在子网掩码的末尾添加或者移除比特来划分网络，官方称之为无分类子网划分。

如创建一个只包含两个主机的网络，其子网掩码为255.255.255.252，一个主机为192.168.0.1，另一个为

192.168.0.2, 逻辑网络地址为192.168.0.0，广播地址是192.168.0.3.



子网记法：/NN.

NN是网络字段所占的位数，如一个C类网络地址的网络部分有24比特,被表示为/24, 上面的255.255.255.252可以表示为/30



### TCP/IP 协议族

也称**TCP/IP四（五）层模型**， 物理层考虑的比较少，因此多数时候称TCP/IP四层模型

TCP/IP 协议族是Internet最基本的协议，HTTP协议是它的一个子集。TCP/IP协议族按层次分为以下四层（网络基础，最好记住）：

* 应用层：

  应用层规定了向用户提供应用服务时通信的协议，如：

  TCP/IP 协议族内预存了各类通用的应用服务协议。比如，FTP（File Transfer Protocol，文件传输协议）和DNS（Domain Name System，域名系统）服务就是其中的两类以及HTTP协议。

  DNS域名系统提供域名（如：[www.baidu.com](https://link.juejin.im?target=https%3A%2F%2Fwww.baidu.com)）到IP地址（如：119.75.217.109）之间的解析服务。

* 传输层

  传输层对接上层应用层，提供处于网络连接中两台计算机之间的数据传输所使用的协议。

  在传输层有两个性质不同的协议：

  TCP（Transmission Control Protocol，传输控制协议）和UDP（User Data Protocol，用户数据报协议）。

  TCP协议是双全工的，即发送数据和接收数据是同步进行的，就好像我们打电话一样，说话的同时也能听见。TCP协议在建立和断开连接时有三次握手和四次挥手，因此在传输的过程中更稳定可靠。

  UDP协议是面向无连接的，也就是说在正式传递数据之前不需要先建立连接。UDP 协议不保证有序且不丢失的传递到对端，也就是说不够稳定，但也正因如此，UDP协议比TCP更加高效和轻便。

* 网络层

  网络层规定了数据通过怎样的传输路线到达对方计算机传送给对方（IP协议等）。

  与对方计算机之间通过多台计算机或网络设备进行传输时，网络层所起的所用就是在众多的选项内选择一条传输路线。

* 链路层

  用来处理连接网络的硬件部分，包括控制操作系统、硬件的设备驱动、NIC（Network Interface Card，网络适配器，即网卡），及光纤等物理可见部分（还包括连接器等一切传输媒介）。硬件上的范畴均在链路层的作用范围之内。

  一般的web应用的通信传输流：

![](http://claymore.wang:5000/uploads/big/9f6deb251afdf35cea4625c43cc576fb.png)

**如果说IP协议是找到对方的详细地址。那么TCP协议就是把安全的把东西带给对方。**



### 打开一个url发生了什么

总体来说分为以下几个过程:

1. DNS解析
2. TCP连接
3. 发送HTTP请求
4. 服务器处理请求并返回HTTP报文
5. 浏览器解析渲染页面
6. 连接结束



#### DNS 解析

DNS存在着多级缓存，从离浏览器的距离排序的话，有以下几种: 浏览器缓存，系统缓存，路由器缓存，IPS服务器缓存，根域名服务器缓存，顶级域名服务器缓存，主域名服务器缓存。

- 在你的chrome浏览器中输入:chrome://dns/，你可以看到chrome浏览器的DNS缓存。
- 系统缓存主要存在/etc/hosts(Linux系统)中:

如果本地没有相关缓存，会到服务器上查找，通过.->.com->google.com->www.google.com 这样从顶级域名递归查找。

​	

#### 地址解析协议(ARP)

ARP(Address Resolution Protocol), 用于关联一个物理设备（如网卡）和一个IP地址。

当再一个网络中捕获 流量时，您将会以不同的频率遇到ARP数据包，因为设备在传递流量时需要定位另一个设备。然而，大多是ARP应答都是单播，因此只有发出请求的设备能看到这个应答。

ARP流量同城不会再网段之间被传递，因此，一个路由器可以被配置以听提供代理ARP的服务，这样它便可以在多个网段中应答ARP请求。





#### DNS负载均衡

DNS每次返回都一个ip,说明访问的是一个服务器，那上万的请求服务器怎么办，其实大型网站都有上百台服务器。

这样，DNS可以返回一个合适的机器的IP给用户，例如可以根据每台机器的负载量，该机器离用户地理位置的距离等等，这种过程就是DNS负载均衡，又叫做DNS重定向。

CDN(Content Delivery Network)就是利用DNS的重定向技术，DNS服务器会返回一个跟用户最接近的点的IP地址给用户，CDN节点的服务器负责响应用户的请求，提供所需的内容。比如我用的七牛作为图床。



#### HTTPS协议

HTTP报文是包裹在TCP报文中发送的，服务器端收到TCP报文时会解包提取出HTTP报文。

但是这个过程中存在一定的风险，HTTP报文是明文，如果中间被截取的话会存在一些信息泄露的风险。那么在进入TCP报文之前对HTTP做一次加密就可以解决这个问题了。

HTTPS协议的本质就是HTTP + SSL(or TLS)。在HTTP报文进入TCP报文之前，先使用SSL对HTTP报文进行加密。从网络的层级结构看它位于HTTP协议与TCP协议之间。

![](http://claymore.wang:5000/uploads/big/8019e4f08a98f28c7bf651a5c16e88a2.png)

关于SSL和TLS,请看：http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html





### 环回地址

环回地址是主机用于向自身发送通信的一个特殊地址（也就是一个特殊的目的地址）。

可以这么说：同一台主机上的两项服务若使用环回地址而非分配的主机地址，就可以绕开TCP/IP协议栈的下层。（也就是说：不用再通过什么链路层，物理层，以太网传出去了，而是可以直接在自己的网络层，运输层进行处理了）

IPv4的环回地址为：127.0.0.0到127.255.255.255都是环回地址（只是有两个特殊的保留），此地址中的任何地址都不会出现在网络中

网络号为127的地址根本就不是一个网络地址（因为产生的IP数据报就不会到达外部网络接口中，是不离开主机的包）

当操作系统初始化本机的TCP/IP协议栈时，设置协议栈本身的IP地址为127.0.0.1（保留地址），并注入路由表。当IP层接收到目的地址为127.0.0.1（准确的说是：网络号为127的IP）的数据包时，不调用网卡驱动进行二次封装，而是立即转发到本机IP层进行处理，由于不涉及底层操作。因此，ping 127.0.0.1一般作为测试本机TCP/IP协议栈正常与否的判断之一。

所以说：127.0.0.1是保留地址之一，只是被经常的使用，来检验本机TCP/IP协议栈而已 

如果我们可以ping通的话，就说明：本机的网卡和IP协议安装都没有问题。（跟我们当前主机有没有联网没有一点关系）


