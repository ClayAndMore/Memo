
---
title: "iptables.md"
date: 2019-12-13 17:48:06 +0800
lastmod: 2020-05-15 18:43:09 +0800
draft: false
tags: [""]
categories: [""]
author: "Claymore"

---
- `iptables`：用来管理 Linux 防火墙的命令程序，位于`/sbin/iptables`目录下，属于`用户空间`的防火墙管理体系。
- `netfilter：Linux` 内核中实现包过滤防火墙的内部结构，一般`不以程序`或`文件`的形式存在，属于`内核空间`的防火墙管理体系。



## Iptables

四表五链：iptables包含4个表，5个链。

**表是按照对数据包的操作区分的，链是按照不同的Hook点来区分的，**表和链实际上是netfilter的两个维度



![](https://images2015.cnblogs.com/blog/1124877/201703/1124877-20170313192222073-1011363533.png)

不同的表包含的链不同。



### 四表（Tables）

**表的处理优先级：raw>mangle>nat>filter**， 如图中从左到右。

* raw:有限级最高，决定数据包是否被状态跟踪机制处理， 设置raw时一般是为了不再让iptables做数据包的链接跟踪处理，提高性能
* mangle:用于对特定数据包的修改， 修改数据包的服务类型、TTL（存活时间）、并且可以配置路由
* nat: 用于网络地址转换（IP、端口），端口映射，地址映射等
* filter：一般的过滤功能（没有指定表的时候就是filter表）



### 五链（Chains）

- **PREROUTING（进路由）:数据包进入路由表之前。**

  当一个数据包进入网卡时，数据包首先进入PREROUTING链，在PREROUTING链中我们有机会修改数据包的DestIP(目的IP)，然后内核的"路由模块"根据"数据包目的IP"以及"内核中的路由表"判断是否需要转送出去(注意，这个时候数据包的DestIP有可能已经被我们修改过了)

- **INPUT（进本机）:通过路由表后目的地为本机，**

  数据包的目的IP是本机的网口IP)，数据包到达INPUT链。数据包到达INPUT链后，任何进程都会-收到它

- **OUTPUT（出本机）:由本机产生，向外转发**

  本机上运行的程序也可以发送数据包，这些数据包经过OUTPUT链，然后到达POSTROTING链输出(注意，这个时候数据包的SrcIP有可能已经被我们修改过了)

- **FORWARDING:通过路由表后，目的地不为本机.**

  如果数据包是要转发出去的(即目的IP地址不再当前子网中)，且内核允许转发，数据包就会向右移动，经过FORWARD链，然后到达POSTROUTING链输出(选择对应子网的网口发送出去)

- **POSTROUTIONG(出路由):发送到网卡接口之前。**

![](https://www.linuxidc.com/upload/2012_08/120807094039061.gif)



**到本机某进程的报文：PREROUTING --> INPUT**

**由本机转发的报文：PREROUTING --> FORWARD --> POSTROUTING**

**由本机的某进程发出报文（通常为响应报文）：OUTPUT --> POSTROUTING**



### Targets

防火墙的规则指定所检查包的特征，和目标。如果包不匹配，将送往该链中下一条规则检查；

如果匹配,那么下一条规则由目标值确定。 **该目标值可以是用户定义的链名,或是某个专用值,如ACCEPT[通过], DROP[删除], QUEUE[排队], 或者 RETURN[返回]。** 

* ACCEPT 表示让这个包通过。
* DROP表示将这个包丢弃。
* QUEUE表示把这个包传递到用户空间。
* RETURN表示停止这条链的匹配，到前一个链的规则重新开始。如果到达了一个内建的链(的末端)，或者遇到内建链的规则是RETURN，包的命运将由链准则指定的目标决定。





### 处理动作

处理动作在iptables中被称为target（这样说并不准确，我们暂且这样称呼），动作也可以分为基本动作和扩展动作。

此处列出一些常用的动作，之后的文章会对它们进行详细的示例与总结：

* **ACCEPT**：允许数据包通过。
* **DROP**：直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会有反应。
* **REJECT**：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息。
* **SNAT**：源地址转换，解决内网用户用同一个公网地址上网的问题。
* **MASQUERADE**：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上。
* **DNAT**：目标地址转换。
* **REDIRECT**：在本机做端口映射。
* **LOG**：在/var/log/messages文件中记录日志信息，然后将数据包传递给下一条规则，也就是说除了记录以外不对数据包做任何其他操作，仍然让下一条规则去匹配。



#### SNAT和MASQUERADE的区别

https://blog.csdn.net/wuruixn/article/details/8103374

