Tags:[nosql, database, mongodb]

### 写在前面

MongoDB 是由C++语言编写的，是一个基于**分布式**文件存储的开源数据库系统。

MongoDB 将数据存储为一个文档，数据结构由键值(key=>value)对组成。

MongoDB 文档类似于 JSON 对象。字段值可以包含其他文档，数组及文档数组。文档结构类似与json对象。

但是我们mongodb的数据存储格式叫： BSON

BSON和JSON的区别：

* 更快的遍历速度：对JSON格式来说，太大的JSON结构会导致数据遍历非常慢。在JSON中，要跳过一个文档进行数据读取，需要对此文档进行扫描才行，需要进行麻烦的[数据结构匹配，比如括号的匹配，而BSON对JSON的一大改进就是，它会将JSON的每一个元素的长度存在元素的头部，这样你只需要读取到元素长度就能直接seek到指定的点上进行读取了。
* 存储变化： 对JSON来说，数据存储是无类型的，比如你要修改基本一个值，从9到10，由于从一个字符变成了两个，所以可能其后面的所有内容都需要往后移一位才可以。而使用BSON，你可以指定这个列为数字列，那么无论数字从9长到10还是100，我们都只是在存储数字的那一位上进行修改，不会导致数据总长变大。当然，在MongoDB中，如果数字从整形增大到长整型，还是会导致数据总长变大的。
* 增加额外数据类型。 JSON是一个很方便的数据交换格式，但是其类型比较有限。BSON在其基础上增加了“byte array”数据类型。这使得二进制的存储不再需要先base64转换后再存成JSON。大大减少了计算开销和数据大小。

当然这些优点，会牺牲掉空间。



### 命名

#### key

**key的格式可以不相同**, 最好同一格式保存到同一集合。

键不能包含`\0(空字符)` , 这个字符用于表示键的结尾。

`.和$具有特殊意义`, 通常被保留



#### 集合

不能以system开头， 这个是系统保留集合

system.users保存着数据库的用户信息。

system.namespaces保存着所有数据库集合的信息。

使用.分割不同命令空间的子集合， 如blog.posts， blog.authors

这里的blog集合不需要存在， 只是说这样命名集合更具有结构性。



#### 数据库

数据库名不能有空字符串和标点，因为最后该名是要变成文件， 区分大小写，最好全部小写。

数据库名可以是满足以下条件的任意UTF-8字符串。

- 不能是空字符串（"")。
- 不得含有' '（空格)、.、$、/、\和\0 (空字符)。
- 应全部小写。
- 最多64字节。

有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库。

- **admin**： 从权限的角度来看，这是"root"数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。
- **local:** 这个数据永远不会被复制，可以用来存储限于本地单台服务器的任意集合
- **config**: 当Mongo用于分片设置时，config数据库在内部使用，用于保存分片的相关信息。



命名空间： 数据库名+集合名

如cms数据库的blog.posts集合：`cms.blog.posts`

获取 时可以 cms.blog[posts], 这样可以获取那些怪异的名字。 



### 数据类型

* null `{"x": null}`
* 布尔 false,true
* 数值 默认64位浮点，对于整数可以使用NumberInt(4字节带符号整数)，NumberLong(8字节带符号整数)
* 字符串， UTF-8
* 日期，毫秒数`{"x": new Date()}`
* 正则 ， 语法和js的正则表达式语法相同`{"x":  /foobar/i}`
* 数组
* 内嵌文档
* 对象id, 12字节ID，`{"x": ObjectId()}`
* 二进制数据， 是一个任意字节的字符串， 不能在shell里使用





### 应答和非应答

默认操作都会等待数据库响应（写入是否成功），然后才会继续执行，这是应答式写入。

非应答式写入不返回任何响应，所以无法知道写入是否成功。

通常来说，都应使用应答式，但是对于一些不重要的数据，可以使用非应答式。

原来默认的写入机制是非应答式， 如Connection类

现在写入的安全机制都变为应答式，开始使用MongoClient类。



### 集合

* 集合collection：

  ```
  {"site":"www.baidu.com"}
  {"site":"www.google.com","name":"Google"}
  {"site":"www.runoob.com","name":"菜鸟教程","num":5}
  ```
  类似于表（tables)。

  删除集合： 

  ```
  db.collection.drop()
  ```

  以下实例删除了 runoob 数据库中的集合 site：

  ```
  > use runoob
  switched to db runoob
  > show tables
  site
  > db.site.drop()
  true
  > show tables
  > 
  ```
  清空集合，删除所有文档，但是保留集合：

  `db.collection.remove()`

* capped collections

  为固定大小的collection.

  它有很高的性能以及队列过期的特性(过期按照插入的顺序). 

  必须要显式的创建一个capped collection， 指定一个collection的大小，单位是字节。collection的数据存储空间值提前分配的。


  `db.createCollection("mycoll", {capped:true, size:100000})`

* 元数据

  数据库的信息存在集合中，使用了系统的命名空间：

  | 集合命名空间                   | 描述                      |
  | ------------------------ | ----------------------- |
  | dbname.system.namespaces | 列出所有名字空间。               |
  | dbname.system.indexes    | 列出所有索引。                 |
  | dbname.system.profile    | 包含数据库概要(profile)信息。     |
  | dbname.system.users      | 列出所有可访问数据库的用户。          |
  | dbname.local.sources     | 包含复制对端（slave）的服务器信息和状态。 |




### 常用类型

| 数据类型               | 描述                                       |
| ------------------ | ---------------------------------------- |
| String             | 字符串。存储数据常用的数据类型。在 MongoDB 中，UTF-8 编码的字符串才是合法的。 |
| Integer            | 整型数值。用于存储数值。根据你所采用的服务器，可分为 32 位或 64 位。   |
| Boolean            | 布尔值。用于存储布尔值（真/假）。                        |
| Double             | 双精度浮点值。用于存储浮点值。                          |
| Min/Max keys       | 将一个值与 BSON（二进制的 JSON）元素的最低值和最高值相对比。      |
| Arrays             | 用于将数组或列表或多个值存储为一个键。                      |
| Timestamp          | 时间戳。记录文档修改或添加的具体时间。                      |
| Object             | 用于内嵌文档。                                  |
| Null               | 用于创建空值。                                  |
| Symbol             | 符号。该数据类型基本上等同于字符串类型，但不同的是，它一般用于采用特殊符号类型的语言。 |
| Date               | 日期时间。用 UNIX 时间格式来存储当前日期或时间。你可以指定自己的日期时间：创建 Date 对象，传入年月日信息。 |
| Object ID          | 对象 ID。用于创建文档的 ID。                        |
| Binary Data        | 二进制数据。用于存储二进制数据。                         |
| Code               | 代码类型。用于在文档中存储 JavaScript 代码。             |
| Regular expression | 正则表达式类型。用于存储正则表达式。                       |





### 方法

#### limit

返回记录条数，

eg:

```
> db.col.find({},{"title":1,_id:0}).limit(2)
{ "title" : "PHP 教程" }
{ "title" : "Java 教程" }
>
```

第一个{}表示where条件，为空则返回所有文档。

第二个{}表示制定哪些列显示和不显示（0不显示，1显示），如果都没有制定，则表示显示所有。

#### skip

跳过指定数量数据，

想要读取从 10 条记录后 100 条记录，相当于 sql 中limit (10,100)。

```
> db.COLLECTION_NAME.find().skip(10).limit(100)
```

以上实例在集合中跳过前面 10 条返回 100 条数据。

skip 和 limit 结合就能实现分页。

但数量非常多的话，skip会变的很慢，因为要查找然后再抛弃，**避免使用skip略过大量结果**

一般可以找到一种方法不使用skip跳过分页，取决于查询本身，如：

```
// 按照"date" 降序显示文档列表，如下获取第一页：
db.foo.find().sort({"date":-1}).limit(100)

// 获取第二页，不推荐skip
db.foo.find().sort({"date":-1}).skip(100).limit(100)

// 推荐, lastdate是上
db.foo.find({"date": {"$gt": lastdate}}).sort({"date":-1}).limit(100)
```





#### sort

sort()方法对数据进行排序，sort()方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而-1是用于降序排列。

```
>db.COLLECTION_NAME.find().sort({KEY:1})
```

KEY是字段名称。

当查询时同时使用sort,skip,limit，无论位置先后，最先执行顺序 sort再skip再limit。



### 副本集（复制）

就是数据备份，一台主节点负责和客户端交互数据，从节点负责定期轮询主节点，获取主节点的操作然后对自己的数据操作，保持数据的一致。

特点是当主节点宕机，其他节点都自动可以当作主节点，保证服务运行。



### 分片

**基本思想**就是将集合切成小块，这些块分散到若干片里，每个片只负责总数据的一部分，最后通过一个均衡器来对各个分片进行均衡（数据迁移）。通过一个名为mongos的路由进程进行操作，mongos知道数据和片的对应关系（通过配置服务器）。大部分使用场景都是解决磁盘空间的问题，对于写入有可能会变差。