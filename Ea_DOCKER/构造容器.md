Tags:[Docker]

### 构造容器

#### 实现run命令

类似于`docker run -ti [command]`

目录结构：

```
root@:~/go_workspace/src# tree runc_run/
runc_run/
├── main_command.go
├── main.go
├── runc_run
├── run.go
└── vendor
    └── container
        ├── container_process.go
        └── init.go
```



main.go:

```go
package main

import (
        log "github.com/Sirupsen/logrus"
        "github.com/urfave/cli"   //使用一命令行工具
        "os"
)

const usage = `mydocker is a simple container runtime implementation.
                           The purpose of this project is to learn how docker works and how to write a docker by ourselves
                           Enjoy it, just for fun.`

func main() {
        app := cli.NewApp()
        app.Name = "mydocker"
        app.Usage = usage

        app.Commands = []cli.Command{
                initCommand,
                runCommand,
        }
//初始化logrus的日志配置
        app.Before = func(context *cli.Context) error {
                // Log as JSON instead of the default ASCII formatter.
                log.SetFormatter(&log.JSONFormatter{})

                log.SetOutput(os.Stdout)
                return nil
        }

        if err := app.Run(os.Args); err != nil {
                log.Fatal(err)
        }
}
```

main_command.go：

```go
package main

import (
        "fmt"
        log "github.com/Sirupsen/logrus"
        "github.com/urfave/cli"
        container //因为用了render, 原来是："github.com/xianlubird/mydocker/container"
    	
)

var runCommand = cli.Command{
        Name: "run",
        Usage: `Create a container with namespace and cgroups limit
                        mydocker run -ti [command]`,
        Flags: []cli.Flag{
                cli.BoolFlag{
                        Name:  "ti",
                        Usage: "enable tty",
                },
        },
        Action: func(context *cli.Context) error {
                if len(context.Args()) < 1 {
                        return fmt.Errorf("Missing container command")
                }
                cmd := context.Args().Get(0)
                tty := context.Bool("ti")
                Run(tty, cmd)   /* 准备启动容器 */
                return nil
        },
}

var initCommand = cli.Command{
        Name:  "init",
        Usage: "Init container process run user's process in container. Do not call it outside",
        Action: func(context *cli.Context) error {
                log.Infof("init come on")
                cmd := context.Args().Get(0)
                log.Infof("command %s", cmd)
                err := container.RunContainerInitProcess(cmd, nil)
                return err
        },
}
```

run.go:

```go
package main

import (
        container //"github.com/xianlubird/mydocker/container"
        log "github.com/Sirupsen/logrus"
        "os"
)


func Run(tty bool, command string) {
        parent := container.NewParentProcess(tty, command)
        if err := parent.Start(); err != nil {
                log.Error(err)
        }
        parent.Wait()
        os.Exit(-1)
}
```



container/container_process.go:

```go
package container
  
import (
    "syscall"
    "os/exec"
    "os"
)

func NewParentProcess(tty bool, command string) *exec.Cmd {
    args := []string{"init", command}  // 注意这里的init
    cmd := exec.Command("/proc/self/exe", args...)
    cmd.SysProcAttr = &syscall.SysProcAttr{
        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS |
        syscall.CLONE_NEWNET | syscall.CLONE_NEWIPC,
    }
    if tty {
        cmd.Stdin = os.Stdin
        cmd.Stdout = os.Stdout
        cmd.Stderr = os.Stderr
    }
    return cmd
}

```

container/init.go:

```go
package container
  
import (
    "os"
    "syscall"
    "github.com/Sirupsen/logrus"
)

func RunContainerInitProcess(command string, args []string) error {
    logrus.Infof("command %s", command)

    defaultMountFlags := syscall.MS_NOEXEC | syscall.MS_NOSUID | syscall.MS_NODEV
    syscall.Mount("proc", "/proc", "proc", uintptr(defaultMountFlags), "")
    argv := []string{command}
    if err := syscall.Exec(command, argv, os.Environ()); err != nil {
        logrus.Errorf(err.Error())
    }
    return nil
}

```



#### 流程

1. cli 命令行解析 `runc_run run -it /bin/sh`
2. `runCommand - > Run('run', 'it') -> container.NewParentProcess(True, 'run')`
3. cmd : `/proc/self/exe init run` 
4. mount :`/proc `



#### 其他参考

http://www.sel.zju.edu.cn/?p=840